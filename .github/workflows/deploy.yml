name: Deploy React App - Vite (dist)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm install
        echo "‚úÖ Dependencies installed"
      
    - name: Build application
      run: |
        echo "üî® Building React app..."
        npm run build
        echo "‚úÖ Build completed"
      env:
        CI: false
        # Agrega aqu√≠ tus variables de entorno de build
        # VITE_API_URL: ${{ secrets.VITE_API_URL }}
        # VITE_APP_TITLE: "Mi App"
    
    - name: Verify build output
      run: |
        echo "üîç Verifying build output..."
        
        # Verificar que existe el directorio dist
        if [ ! -d "dist" ]; then
          echo "‚ùå ERROR: dist directory does not exist"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        # Verificar que no est√° vac√≠o
        if [ -z "$(ls -A dist)" ]; then
          echo "‚ùå ERROR: dist directory is empty"
          exit 1
        fi
        
        # Mostrar informaci√≥n
        echo "‚úÖ dist directory verified"
        echo ""
        echo "üìä Build statistics:"
        echo "  ‚Ä¢ Files: $(find dist -type f | wc -l)"
        echo "  ‚Ä¢ Size: $(du -sh dist | cut -f1)"
        echo ""
        echo "üìÅ dist contents:"
        ls -lah dist/ | head -20
        
        # Verificar index.html
        if [ ! -f "dist/index.html" ]; then
          echo "‚ö†Ô∏è  WARNING: index.html not found in dist/"
        else
          echo "‚úÖ index.html found"
        fi
    
    - name: Create deployment package
      run: |
        echo "üì¶ Creating deployment package..."
        cd dist
        tar -czf ../deploy.tar.gz .
        cd ..
        echo "‚úÖ Package created"
        ls -lh deploy.tar.gz
    
    - name: Deploy package to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: "deploy.tar.gz"
        target: "/tmp/"
    
    - name: Extract and deploy on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          set -e
          
          APP_NAME="${{ secrets.APP_NAME }}"
          APP_DIR="/var/www/${APP_NAME}"
          
          echo "üöÄ Starting deployment process..."
          
          # Verificar que lleg√≥ el archivo
          if [ ! -f "/tmp/deploy.tar.gz" ]; then
            echo "‚ùå ERROR: deploy.tar.gz not found"
            exit 1
          fi
          
          echo "‚úÖ Deployment package received ($(du -h /tmp/deploy.tar.gz | cut -f1))"
          
          # Crear directorio de la app
          sudo mkdir -p "$APP_DIR"
          
          # Limpiar directorio actual
          echo "üßπ Cleaning old files..."
          sudo rm -rf $APP_DIR/*
          
          # Extraer archivos nuevos
          echo "üì§ Extracting new files..."
          sudo tar -xzf /tmp/deploy.tar.gz -C "$APP_DIR"
          
          # Limpiar archivo temporal
          rm /tmp/deploy.tar.gz
          
          # Establecer permisos
          echo "üîê Setting permissions..."
          sudo chown -R www-data:www-data "$APP_DIR"
          sudo chmod -R 755 "$APP_DIR"
          
          # Verificar deployment
          if [ ! -f "$APP_DIR/index.html" ]; then
            echo "‚ùå ERROR: index.html not found after deployment"
            echo "Directory contents:"
            sudo ls -la "$APP_DIR"
            exit 1
          fi
          
          echo "‚úÖ Files deployed successfully"
          echo ""
          echo "üìä Deployment statistics:"
          echo "  ‚Ä¢ Files: $(sudo find $APP_DIR -type f | wc -l)"
          echo "  ‚Ä¢ Size: $(sudo du -sh $APP_DIR | cut -f1)"
          
          # Recargar Apache
          echo "üîÑ Reloading web server..."
          sudo systemctl reload apache2
          
          echo ""
          echo "‚úÖ Deployment completed successfully!"
          echo "üìÖ Deployed at: $(date)"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"